
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Language Model Trainer</title>
    
<script src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="css/jquery.dataTables.css">
<link rel="stylesheet" href="css/jquery-ui.css">
  <script src="js/jquery-ui.js"></script>


<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="js/bootstrap.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
<style>

div.doc-viewer {
    width: 100%;
    height: 600px;
    border: 1px solid #ccc;
    padding: 5px;
    overflow-x: hidden;
    float:left;
    background:white;
}

.concept-class-prob {
	color:red;
	cursor:pointer
}

.concept-class-trea {
	color:blue;
	cursor:pointer
}

.concept-class-test {
	color:green;
	cursor:pointer
}



.navbar {
background-image: linear-gradient(to bottom,#1aac9b,#1AAC7F 100%)
}

.concept-key{
	position:relative;
	right:0px;
	text-align:right
}

.changed{
	background-color: khaki;
}

.document-selected {
	background-color:rgb(178, 240, 255) !important;
}

.popover-title{
	background-color:rgb(183, 196, 247);
}


/* Thanks to: http://stackoverflow.com/questions/1964839/jquery-please-wait-loading-animation/1964871#1964871 */

/* Start by setting display:none to make this hidden.
   Then we position it in relation to the viewport window
   with position:fixed. Width, height, top and left speak
   for themselves. Background we set to 80% white with
   our animation centered, and no-repeating */
.modal {
    display:    none;
    position:   fixed;
    z-index:    1000;
    top:        0;
    left:       0;
    height:     100%;
    width:      100%;
    background: rgba( 255, 255, 255, .8 ) 
                url('images/loading.gif') 
                50% 50% 
                no-repeat;
    
}

.modal span{
  position: absolute;
  top: 54%;
  width: 100%;
  text-align: center;
}

/* When the body has the loading class, we turn
   the scrollbar off with overflow:hidden */
body.loading {
    overflow: hidden;   
}

/* Anytime the body has the loading class, our
   modal element will be visible */
body.loading .modal {
    display: block;
}

.table-caption {
	color:rgb(66, 66, 208);
	font-size:25px;
}

h1 a {
	font-size:20px;
}

	
</style>    
    
    
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>

        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right">
            

          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Language Model Trainer <a href=# onclick=showHelpPopovers()>help</a></h1>
        
        <input id="host-domain" type=text value="host.domain:port"></input>
        <button id="populate-button" onClick=loadModel() >populate </button>
        <br>
        <input id="model-path" type=text value="modelFilename.ser"></input>
        
       

      </div>
    </div>
    

    <div class="container">
    
      <!-- Example row of columns -->
     <div class="row">
     <div class="col-md-3">
     <span class=table-caption>Document List</span>
     <table id="document-list" class="display compact" cellspacing="0" width="100%">
        	
        	<thead>
            	<tr>
                	<th>DocID</th>
                	<th>Date</th>
                	<th>ID Name</th>
                	

            	</tr>
        	</thead>
 
        	<tfoot>
            	<tr>
                	<th>DocID</th>
                	<th>Date</th>
                	<th>ID Name</th>
                	
                	
            	</tr>
        	</tfoot>
    </table>
          
    </div>
    
    
        <div class="col-md-6">
        <div class="concept-key">
    	<a id="download-button" hidden=true href="rest/document-view/download-most-recent"><button>Download</button></a>
    	<button id=train-button onClick=train()>Train</button>
    	<button id=save-button onClick=saveMentions()>Save</button>
    	
    	<span class="concept-class-prob">Problem</span>
    	<span class="concept-class-test">Test</span>
    	<span class="concept-class-trea">Treatment</span>
    	<span class="changed">Modified</span>
    </div>
          
          <div id=doc-viewer class="doc-viewer"></div>
       </div>
       
       <div class="col-md-3">
    <span id=change-log-title class=table-caption> Change Log</span>
    <table id="change-log" class="display compact" cellspacing="0" width="100%">
        	<thead>
            	<tr>
                	<th>From</th>
                	<th>To</th>
                	
            	</tr>
        	</thead>
 
        	<tfoot>
            	<tr>
                	<th>From</th>
                	<th>To</th>
                	
            	</tr>
        	</tfoot>
    </table>
    
    </div>

      </div>
      
  <div class="modal"><span></span></div>
  <div id="dialog-form" title="Choose Concept Type For">
  <p id="selected-mention" class="validateTips"></p>
</div>
      
      
      <hr>

      <footer>
        <p>&copy; Company 2014</p>
      </footer>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    
    <script type="text/javascript">
    var mentions = []
    var docText
    var cur_class_selection
    var cur_mention_selection
    var loadingScreen = true;
    var changeLogTable;
    var changeLogItems = [];
    
    var loading_messages = [ "Hang on a sec, I know your data is here somewhere",
                             "Don't think of purple hippos",
                             "Please wait while we test your patience",
                             "Please wait, the server is powered by a lemon and two electrodes"
                            ]
    
    
    $(document).ready(function() {
         table =  $('#document-list').dataTable( {
            "ajax": "rest/document-list",
            
            
        } );
         
         changeLogTable = $('#change-log').DataTable({"bSort": false});
    	
   
    
    $('#document-list tbody').on('click', 'tr', function () {
        var docID = $('td', this).eq(0).text();
        $(".document-selected").removeClass("document-selected")
        this.classList.add("document-selected");
        doDocumentSelected(docID)
    } );
    
    $('#doc-viewer').on('mouseup', doTextSelected );
    $('#doc-viewer span').on('mousedown', doConceptSelected );
    
    
 
    dialog = $( "#dialog-form" ).dialog({
        autoOpen: false,
        height: 150,
        width: 350,
        modal: true,
        buttons: {
          "Problem": function(){updateMentionType(cur_mention_selection,"concept-class-prob"); dialog.dialog("close")},
          "Treatment": function(){updateMentionType(cur_mention_selection,"concept-class-trea"); dialog.dialog("close")},
          "Test":function(){updateMentionType(cur_mention_selection,"concept-class-test"); dialog.dialog("close")},
            "None":function(){updateMentionType(cur_mention_selection,"concept-class-none"); dialog.dialog("close")},
        },
        close: function() {
          
        }
      });
    
       
    
    $('[data-toggle="tooltip"]').tooltip()
    } );
    
    var foo;
	function doTextSelected() {
		
        
    	var selection = window.getSelection()
    	if(selection.getRangeAt)
    	{
    		var base = selection.getRangeAt(0).startOffset
    		var extent = selection.getRangeAt(0).endOffset
    	}
    	else
    	{
        	var base = selection.baseOffset
        	var extent = selection.extentOffset
    	}
    	var selected_text = selection.toString()
    	
        if(extent == base)
        	return false
        
        var offset = getOffset(selection)
       
        var concept_type = $('input[name="type"]:checked').val();
    	var class_name = "concept-class-none";
    	var m = new mention(offset + base+1, offset + extent+1,selected_text,class_name)
    	mentions.push(m)

    	updateDocument()
    	
    	
    	doConceptSelected(false,mentions.indexOf(m));
    	
    	
    }
	
	function doConceptSelected(changed,i){
		
		
		cur_mention_selection = parseInt(i)
		mentions[cur_mention_selection]["changed"] = false
		$("#selected-mention").text(mentions[cur_mention_selection].text)
		dialog.dialog("open")	
	}
	
	function updateMentionType(index,class_name){
		
		from = cloneMention(mentions[index]);
		mentions[index].class_name = class_name
		
		to = cloneMention(mentions[index]);
		addToChangeLog(from,to,mentions[index])
		
		updateDocument()
		
	}
	
	function addToChangeLog(from,to,orig)
	{
		
		changeLogItems.push({"from":from,"to":to,"orig":orig})
		
		fromHTML = "<span class="+from.class_name+">"+from.text+"</span>"
		toHTML = "<span class="+to.class_name+">"+to.text+"</span>"
		changeLogTable.row.add([fromHTML,toHTML]).draw();
		$('#change-log tbody tr').on('mouseenter', highlightChange);
	    $('#change-log tbody tr').on('mouseleave', unHighlightChange);
	    //$('#change-log tr.even').on('mouseenter', highlightChange);
	    //$('#change-log tr.even').on('mouseout', unHighlightChange);
	}

	function highlightChange()
	{
		var index = this.rowIndex - 1;
		changeLogItems[index].orig.changed = true;
		updateDocument()
	}
	
	function unHighlightChange()
	{
		var index = this.rowIndex - 1;
		changeLogItems[index].orig.changed = false;
		updateDocument()
	}
	
	function cloneMention(m)
	{
		return new mention(m.offset,m.extent,m.text, m.class_name)
	}
	
    var docID_g
	
    function doDocumentSelected(docID)
    {
    	doSavePrompt();
    	
    	mentions = [];
    	docID_g = docID
    	loadingScreen = false;
    	$.get("rest/document-view?docId="+docID,updateDocumentViewerHTML)
    	loadingScreen = true;
    	
    }
    
    function doSavePrompt()
    {
    	if(changeLogItems == 0)
    		return
    		
    	if(confirm("Save Changes?"))
    		saveMentions()
    	
    	
    		
    	
    }
    
    function updateDocumentViewerHTML(text)
    {
    	
    	docText = text.replace(/\n|\r/g,'');
    	$("#doc-viewer").html(text);
    	$.get("rest/document-view/mentions?docId="+docID_g,populateMentions)
    	
    }
    

    function populateMentions(data)
    {
    	/*
    	for(i=0; i<data.length; i++)
    	{
    		var d = data[i];
    		m = new mention(d.offset,d.extent,d.text, d.class_name);
    		mentions.push(m);
    	}
    	*/
    	mentions = data
    	
    	updateDocument();
    }
    
    function getSelectionText() {
        var text = "";
        if (window.getSelection) {
            text = window.getSelection().toString();
        } else if (document.selection && document.selection.type != "Control") {
            text = document.selection.createRange().text;
        }
        return text;
    }
    
    function mention(offset,extent,text,class_name)
    {
    	this.offset = offset
    	this.extent = extent
    	this.text = text
    	this.class_name = class_name
    	this.changed = false
    }
    
    function keysrt(key) {
    	  return function(a,b){
    	   if (a[key] > b[key]) return 1;
    	   if (a[key] < b[key]) return -1;
    	   return 0;
    	  }
    	}
    
    function updateDocument()
    {
    	mentions.sort(keysrt("offset"))
    	cleanMentionList()
    	var m
    	var text =  docText.replace(/\n/g, "")

    	var prevMention
    	for(var i = 0; i<mentions.length; i++)
    	{
    		
    		m = mentions[i]
    		
    		// 84 is additional characters added by markup.
    		var markup_length = i*86
    		
    		var left = text.substring(0,m.offset+markup_length-1)
    		var right = text.substring(m.extent+markup_length-1)
    		
    		var index = ("00"+i).slice(-3)
    		var class_str = m.class_name + ((m.changed) ? " changed":" noChang");
    		
    		
    		var insert = "<span onClick=doConceptSelected(true,\""+index+"\") class=\""+class_str+"\">"+m.text+"</span>"
    		//console.log(insert);
        	text = left+insert+right
        	
        	
        	//replace(/\n/g, "<br />")
    	}	
    	$("#doc-viewer").html(text);
    }
    //sort and remove overlapping mentions
    function cleanMentionList()
    {
    	mentions.sort(keysrt("offset"))
    	removed = 0;
    	for(i=1; i< mentions.length; i++)
    	{
    		index = i-removed;
    		
    		curMen = mentions[index]
    		prevMen = mentions[index-1]
    		if(curMen.offset<prevMen.extent)
    		{
    			mentions.splice(index,1)
    			removed++;
    		}	
    			
    	}
    	
    }
    
    function getOffset(selection)
    {
    	var offset = 0
    	
    	if(selection.focusNode)
    	{	
    		var sib = selection.focusNode.previousSibling
    	}
    	else
    	{	
    		var sib = selection.baseNode.previousSibling
    	}
    	
    		while(sib)
    	{
    		if(sib.nodeName == "SPAN")
    		{	
    			offset += sib.innerHTML.length
    		}
    		else
    			offset += sib.length
    		sib = sib.previousSibling
    				
    	}
    	return offset
    }
    
    
    function loadModel()
    {
    	
    	var domain = $("#host-domain").val();
    	
    	$.ajax({
    	    url: "http://"+domain+"/openmrs/module/bannerprototype/transport.form",
    	 
    	    // The name of the callback parameter, as specified by the YQL service
    	    jsonp: "sendJsonData",
    	 
    	    // Tell jQuery we're expecting JSONP
    	    dataType: "jsonp",
    	 
    	    
    	});
    
    	
    }
    
    var d
    
    function sendJsonData(data)
    {
    	
    	d = data
    	console.log(data);
    	$.post("rest/document-list/load-documents",
    			{"data":JSON.stringify(data)},
    			success=refreshTable
    			)
    }
    
    function refreshTable(){
    	
    	$('#document-list').DataTable().ajax.reload()
    }
    
    function saveMentions()
    {
    	data = JSON.stringify(mentions)
    	console.log(data);
    	$.post("rest/document-view/save-mentions",
    			{"data":data,
    		    "docId":docID_g},
    			success=refreshTable
    			)
    			
    	changeLogItems = [];
    	changeLogTable.clear().draw()
    	
    }
    
    function train()
    {
    	var model_path = $("#model-path").val();
    	$.post("rest/document-view/train",
    			{"path":model_path},
    			success=function(){
    				alert("Training Completed, please download your model")
					$("#download-button").show()
    			}
    			)
    }
    
    
    $body = $("body");

    $(document).on({
        ajaxStart: function() {
        	if(loadingScreen)
        	{	
        		var message_index = Math.floor(Math.random()*loading_messages.length);
        		$(".modal span").text(loading_messages[message_index])
        		$body.addClass("loading");
        	}
        	},
         ajaxStop: function() {
        	 if(loadingScreen)
        	 	$body.removeClass("loading"); }    
    });
    
    function showHelpPopovers()
    {
    	trainButtonPopover = {"title":"Train Model",
    						  "content": "Press this button and the application will use the annotations to train a new model",
    						  "placement":"bottom"}
    	
    	saveButtonPopover = {"title":"Save Current Changes",
							 "content": "Press this button to save the changes you have made to the annotations below",
							 "placement":"top"}
    	
    	changeLogPopover = {"title":"Change Log",
				 		   	 "content": "This table shows all changes made to the current document.  Hover over a change to see it highlighed in the document",
							 "placement":"top"}
    	
    	populateButtonPopover = {"title":"Populate",
	 		   	 "content": "put the url port # in the input box to the left and click this button.  This will read documents from the OpenMRS installation and populate the document list",
				 "placement":"bottom"}
    	
    	documentListPopover = {"title":"Document List",
	 		   	 "content": "This table holds a list of annotated documents.  Click on a document to render it in the document viewer",
				 "placement":"right"}
    	
    	docViewerPopover = {"title":"Document Viewer",
	 		   	 "content": "The selected docuemnt is rendered here with annotations highlighed by class.  Annotations can be added by highlighting the text with the cursor.  Click on an annotation to change the class",
				 "placement":"right",
				 "trigger":"focus"}
    	
    	$("#train-button").popover(trainButtonPopover)
    	$("#train-button").popover('show')
    	
    	$("#save-button").popover(saveButtonPopover)
    	$("#save-button").popover('show')
    	
    	$("#change-log-title").popover(changeLogPopover)
    	$("#change-log-title").popover('show')
    	
    	$("#populate-button").popover(populateButtonPopover)
    	$("#populate-button").popover('show')
    	
    	$("#document-list").popover(documentListPopover)
    	$("#document-list").popover('show')
    	
    	$("#doc-viewer").popover(docViewerPopover)
    	$("#doc-viewer").popover('show')
    	
    	
    	setTimeout(function(){$("body").on("click",hideHelpPopovers)},1000);
    }
    
    function hideHelpPopovers()
    {
    	$("#train-button").popover('destroy')
    	$("#save-button").popover('destroy')
    	$("#change-log-title").popover('destroy')
    	$("#populate-button").popover('destroy')
    	$("#document-list").popover('destroy')
    	$("#doc-viewer").popover('destroy')
    	
    	$("body").off("click",hideHelpPopovers)
    	
    	
    	
    }

    </script>
  </body>
</html>
