
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Language Model Trainer</title>
    
<script src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="css/jquery.dataTables.css">
<link rel="stylesheet" href="css/jquery-ui.css">
  <script src="js/jquery-ui.js"></script>


<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="css/bootstrap-theme.min.css">

<!-- Latest compiled and minified JavaScript -->
<script src="js/bootstrap.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
<style>

div.doc-viewer {
    width: 100%;
    height: 600px;
    border: 1px solid #ccc;
    padding: 5px;
    overflow-x: hidden;
    float:left;
    background:white;
}

.concept-class-prob {
	color:red;
	cursor:pointer
}

.concept-class-trea {
	color:blue;
	cursor:pointer
}

.concept-class-test {
	color:green;
	cursor:pointer
}



.navbar {
background-image: linear-gradient(to bottom,#1aac9b,#1AAC7F 100%)
}

.concept-key{
	position:relative;
	right:0px;
	text-align:right
}

.changed{
	background-color: khaki;
}

	
</style>    
    
    
  </head>

  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>

        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right">
            

          </form>
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Language Model Trainer</h1>
        <input id="host-domain" type=text value="host.domain:port"></input>
        <button onClick=loadModel() >populate </button>
        <br>
        <input id="model-path" type=text value="modelFilename.ser"></input>
        
       

      </div>
    </div>
    

    <div class="container">
    <div class="concept-key">
    	<a id="download-button" hidden=true href="rest/document-view/download-most-recent"><button>Download</button></a>
    	<button onClick=train()>Train</button>
    	<button onClick=saveMentions()>Save</button>
    	
    	<span class="concept-class-prob">Problem</span>
    	<span class="concept-class-test">Test</span>
    	<span class="concept-class-trea">Treatment</span>
    	<span class="changed">Modified</span>
    </div>
      <!-- Example row of columns -->
      <div class="row">
        <div class="col-md-6">
        	<table id="document-list" class="display " cellspacing="0" width="100%">
        	<thead>
            	<tr>
                	<th>DocID</th>
                	<th>Date</th>
                	<th>concepts</th>
                	

            	</tr>
        	</thead>
 
        	<tfoot>
            	<tr>
                	<th>DocID</th>
                	<th>Date</th>
                	<th>concepts</th>
                	
                	
            	</tr>
        	</tfoot>
    </table>
          
        </div>
        <div class="col-md-6">
          
          <div id=doc-viewer class="doc-viewer"></div>
       </div>

      </div>
      
  <div id="dialog-form" title="Choose Concept Type For">
  <p id="selected-mention" class="validateTips"></p>
</div>
      
      
      <hr>

      <footer>
        <p>&copy; Company 2014</p>
      </footer>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->

    
    <script type="text/javascript">
    var mentions = []
    var docText
    var cur_class_selection
    var cur_mention_selection
    
    
    $(document).ready(function() {
        $('#document-list').dataTable( {
            "ajax": "rest/document-list"
        } );
   
    
    $('#document-list tbody').on('click', 'tr', function () {
        var docID = $('td', this).eq(0).text();
        doDocumentSelected(docID)
    } );
    
    $('#doc-viewer').on('mouseup', doTextSelected );
    $('#doc-viewer span').on('mousedown', doConceptSelected );
 
    dialog = $( "#dialog-form" ).dialog({
        autoOpen: false,
        height: 150,
        width: 350,
        modal: true,
        buttons: {
          "Problem": function(){updateMentionType(cur_mention_selection,"concept-class-prob"); dialog.dialog("close")},
          "Treatment": function(){updateMentionType(cur_mention_selection,"concept-class-trea"); dialog.dialog("close")},
          "Test":function(){updateMentionType(cur_mention_selection,"concept-class-test"); dialog.dialog("close")},
            "None":function(){updateMentionType(cur_mention_selection,"concept-class-none"); dialog.dialog("close")},
        },
        close: function() {
          
        }
      });
    
    
    } );
    
	function doTextSelected() {
		
        
    	var selection = window.getSelection()
    	if(selection.getRangeAt)
    	{
    		var base = selection.getRangeAt(0).startOffset
    		var extent = selection.getRangeAt(0).endOffset
    	}
    	else
    	{
        	var base = selection.baseOffset
        	var extent = selection.extentOffset
    	}
    	var selected_text = selection.toString()
    	
        if(extent == base)
        	return false
        
        var offset = getOffset(selection)
       
        var concept_type = $('input[name="type"]:checked').val();
    	var class_name = "concept-class-none";
    	var m = new mention(offset + base+1, offset + extent+1,selected_text,class_name)
    	mentions.push(m)

    	updateDocument()
    	
    	
    	doConceptSelected(true,mentions.indexOf(m));
    	
    	
    }
	
	function doConceptSelected(changed,i){
		
		
		cur_mention_selection = parseInt(i)
		mentions[cur_mention_selection]["changed"] = changed
		$("#selected-mention").text(mentions[cur_mention_selection].text)
		dialog.dialog("open")	
	}
	
	function updateMentionType(index,class_name){
		mentions[index].class_name = class_name
		updateDocument()
		
	}
	
    var docID_g
	
    function doDocumentSelected(docID)
    {
    	mentions = [];
    	docID_g = docID
    	$.get("rest/document-view?docId="+docID,updateDocumentViewerHTML)
    	
    }
    
    function updateDocumentViewerHTML(text)
    {
    	
    	docText = text;
    	$("#doc-viewer").html(text);
    	$.get("rest/document-view/mentions?docId="+docID_g,populateMentions)
    	
    }
    

    function populateMentions(data)
    {
    	/*
    	for(i=0; i<data.length; i++)
    	{
    		var d = data[i];
    		m = new mention(d.offset,d.extent,d.text, d.class_name);
    		mentions.push(m);
    	}
    	*/
    	mentions = data
    	
    	updateDocument();
    }
    
    function getSelectionText() {
        var text = "";
        if (window.getSelection) {
            text = window.getSelection().toString();
        } else if (document.selection && document.selection.type != "Control") {
            text = document.selection.createRange().text;
        }
        return text;
    }
    
    function mention(offset,extent,text,class_name)
    {
    	this.offset = offset
    	this.extent = extent
    	this.text = text
    	this.class_name = class_name
    	this.changed = false
    }
    
    function keysrt(key) {
    	  return function(a,b){
    	   if (a[key] > b[key]) return 1;
    	   if (a[key] < b[key]) return -1;
    	   return 0;
    	  }
    	}
    
    function updateDocument()
    {
    	mentions.sort(keysrt("offset"))
    	cleanMentionList()
    	var m
    	var text =  docText.replace(/\n/g, "")

    	var prevMention
    	for(var i = 0; i<mentions.length; i++)
    	{
    		
    		m = mentions[i]
    		
    		// 84 is additional characters added by markup.
    		var markup_length = i*86
    		
    		var left = text.substring(0,m.offset+markup_length-1)
    		var right = text.substring(m.extent+markup_length-1)
    		
    		var index = ("00"+i).slice(-3)
    		var class_str = m.class_name + ((m.changed) ? " changed":" noChang");
    		
    		
    		var insert = "<span onClick=doConceptSelected(true,\""+index+"\") class=\""+class_str+"\">"+m.text+"</span>"
    		//console.log(insert);
        	text = left+insert+right
        	
        	
        	//replace(/\n/g, "<br />")
    	}	
    	$("#doc-viewer").html(text);
    }
    //sort and remove overlapping mentions
    function cleanMentionList()
    {
    	mentions.sort(keysrt("offset"))
    	removed = 0;
    	for(i=1; i< mentions.length; i++)
    	{
    		index = i-removed;
    		
    		curMen = mentions[index]
    		prevMen = mentions[index-1]
    		if(curMen.offset<prevMen.extent)
    		{
    			mentions.splice(index,1)
    			removed++;
    		}	
    			
    	}
    	
    }
    
    function getOffset(selection)
    {
    	var offset = 0
    	
    	if(selection.focusNode)
    	{	
    		var sib = selection.focusNode.previousSibling
    	}
    	else
    	{	
    		var sib = selection.baseNode.previousSibling
    	}
    	
    		while(sib)
    	{
    		if(sib.nodeName == "SPAN")
    		{	
    			offset += sib.innerHTML.length
    		}
    		else
    			offset += sib.length
    		sib = sib.previousSibling
    				
    	}
    	return offset
    }
    
    
    function loadModel()
    {
    	
    	var domain = $("#host-domain").val();
    	
    	$.ajax({
    	    url: "http://"+domain+"/openmrs/module/bannerprototype/transport.form",
    	 
    	    // The name of the callback parameter, as specified by the YQL service
    	    jsonp: "sendJsonData",
    	 
    	    // Tell jQuery we're expecting JSONP
    	    dataType: "jsonp",
    	 
    	    
    	});
    
    	
    }
    
    var d
    
    function sendJsonData(data)
    {
    	
    	d = data
    	console.log(data);
    	$.post("rest/document-list/load-documents",
    			{"data":JSON.stringify(data)},
    			success=refreshTable
    			)
    }
    
    function refreshTable(){
    	
    	$('#document-list').DataTable().ajax.reload()
    }
    
    function saveMentions()
    {
    	data = JSON.stringify(mentions)
    	console.log(data);
    	$.post("rest/document-view/save-mentions",
    			{"data":data,
    		    "docId":docID_g},
    			success=refreshTable
    			)
    	
    }
    
    function train()
    {
    	var model_path = $("#model-path").val();
    	$.post("rest/document-view/train",
    			{"path":model_path},
    			success=function(){
    				alert("Training Completed, please download your model")
					$("#download-button").show()
    			}
    			)
    }
    

    </script>
  </body>
</html>
